<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Bienvenue</title>
    <style>
        .action-button {
            cursor: pointer;
            margin-right: 5px;
        }
        .delete-button {
            color: red;
        }
        .edit-button {
            color: green;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    
    <h1>Bienvenue, <span id="username"></span>!</h1>
    <table border="1" id="clientsTable">
        <h3>Vous avez <span id ="nbUser"> au total</span></h3>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Les données clients seront injectées ici -->
        </tbody>
    </table>
    <form action="/deconnexion" method="get">
        <button type="submit">Déconnexion</button>
    </form>
    <script>
        function getCookie(name) {
            let cookieArray = document.cookie.split(';');
            for(let i = 0; i < cookieArray.length; i++) {
                let cookiePair = cookieArray[i].split('=');
                if(name == cookiePair[0].trim()) {
                    return decodeURIComponent(cookiePair[1]);
                }
            }
            return null;
        }
        document.getElementById('username').textContent = getCookie('username');


        function updateClientCount() {
    $.ajax({
        url: '/api/clients/count',
        method: 'GET',
        success: function(count) {
            $('#nbUser').text(count + " clients au total");  // Mise à jour du texte
        },
        error: function(error) {
            console.log('Erreur lors de la récupération du nombre de clients:', error);
        }
    });
}

function updateClientCount() {
    $.ajax({
        url: '/api/clients/count',
        method: 'GET',
        success: function(count) {
            $('#nbUser').text(count + " clients au total");  // Mise à jour du texte
        },
        error: function(error) {
            console.log('Erreur lors de la récupération du nombre de clients:', error);
        }
    });
}

function loadClients() {
    $.ajax({
        url: '/api/clients',
        method: 'GET',
        success: function(clients) {
            var rows = '';
            clients.forEach(function(client) {
                rows += `<tr data-id="${client.ID_Client}">
                            <td>${client.ID_Client}</td>
                            <td>${client.nom}</td>
                            <td>${client.prenom}</td>
                            <td>${client.email}</td>
                            <td>
                                <span class="action-button edit-button" onclick="editClient(${client.ID_Client}, '${client.nom.replace(/'/g, "\\'")}', '${client.prenom.replace(/'/g, "\\'")}', '${client.email.replace(/'/g, "\\'")}')">✏️</span>
                                <span class="action-button delete-button" onclick="deleteClient(${client.ID_Client})">×</span>
                            </td>
                         </tr>`;
            });
            $('#clientsTable tbody').html(rows);
            updateClientCount(); // Appel pour mettre à jour le nombre de clients
        },
        error: function(error) {
            console.log('Erreur lors de la récupération des clients:', error);
        }
    });
}

$(document).ready(function() {
    loadClients();
});


        function deleteClient(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce client ?')) {
                $.ajax({
                    url: `/api/clients/${id}`,
                    method: 'DELETE',
                    success: function() {
                        loadClients(); // Recharger la liste après suppression
                    },
                    error: function(error) {
                        alert('Erreur lors de la suppression du client');
                    }
                });
            }
        }

    function editClient(id, nom, prenom, email) {
    var row = document.querySelector(`tr[data-id="${id}"]`);
    var formHtml = `<td colspan="5">
                        <form onsubmit="submitEdit(${id}, this); return false;">
                            <input type="text" name="nom" value="${nom}">
                            <input type="text" name="prenom" value="${prenom}">
                            <input type="email" name="email" value="${email}">
                            <button type="submit">Valider</button>
                            <button type="button" onclick="cancelEdit(${id}, '${nom}', '${prenom}', '${email}')">Annuler</button>
                        </form>
                    </td>`;
    row.innerHTML = formHtml;
}
        

     
function submitEdit(id, form) {
    var data = $(form).serialize();
    $.ajax({
        url: `/api/clients/edit/${id}`,
        method: 'POST',
        data: data,
        success: function() {
            loadClients(); // Recharger la liste après modification
        },
        error: function(error) {
            alert('Erreur lors de la modification du client');
        }
    });
}



function cancelEdit(id, nom, prenom, email) {
    var row = document.querySelector(`tr[data-id="${id}"]`);
    row.innerHTML = `
        <td>${id}</td>
        <td>${nom}</td>
        <td>${prenom}</td>
        <td>${email}</td>
        <td>
            <span class="action-button edit-button" onclick="editClient(${id}, '${nom}', '${prenom}', '${email}')">✏️</span>
            <span class="action-button delete-button" onclick="deleteClient(${id})">×</span>
        </td>
    `;
}



        $(document).ready(function() {
            loadClients();
        });
    </script>
</body>
</html>
